#!/bin/sh
set -e
cd "$(dirname "$0")/.."

run() {
    local RETURN=""
    local TRY=0

    echo "[RUN] ${FILE}"

    until [ "${TRY}" -ge 3 ] ; do
        echo -n "$(cd "$1" && melody run "$2")"

        RETURN="$(ls "$1")"
        if [ -n "${RETURN}" ] ; then
            echo "[OK] ${FILE}"
            break
        fi

        echo ""
        TRY="$((${TRY} + 1))"
        sleep 5
    done

    if [ "${TRY}" -ge 3 ] ; then
        echo "[NOK] ${FILE}" >&2
        exit 1
    fi
}

rm -f -r generated/*
for FILE in $(find "${PWD}/src" -name "*.php") ; do
    FOLDER="$(echo "${FILE}" | sed 's@.php$@@')"
    FOLDER="$(echo "${FOLDER}" | sed 's@/src/@/generated/@')"
    mkdir -p "${FOLDER}"

    run "${FOLDER}" "${FILE}"
done
